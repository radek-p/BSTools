
%/* //////////////////////////////////////////////////// */
%/* This file is a part of the BSTools procedure package */
%/* written by Przemyslaw Kiciak.                        */
%/* //////////////////////////////////////////////////// */

\chapter{The \texttt{libxgedit} library}

The procedures of the \texttt{libxgedit} library support the interaction
between an application and a~user, via the XWindow system. The library
makes it possible to open a~number of windows and create various widgets
for user interaction, and it is used \emph{instead} of more sophisticated
packages built on top of XWindow. The library is intended mainly for use
with the demonstration programs of the BSTools packages and perhaps
it is good for nothing else.

\section{Overview}

\section{Auxiliary \#definitions}

\begin{listingC}
typedef unsigned int xgecolour_int;

#define xge_MAX_WINDOWS         8
#define xge_MAX_CURSORS        16

#define xge_MAX_WIDTH   /*1024*/ 1280
#define xge_MAX_HEIGHT  /* 768*/  960
#define xge_WIDTH             480
#define xge_HEIGHT            360

#define XGE_AUTO_ASPECT
#ifndef XGE_AUTO_ASPECT
#define XGE_DEFAULT_ASPECT    1.0
#endif

#define xge_CHAR_WIDTH          6
#define xge_CHAR_HEIGHT        13

#define xge_RECT_NONE          -1
#define xge_MINDIST             8

#define xge_FOCUS_DEPTH         8

#define xge_MAX_STRING_LENGTH 512


#define xgemouse_LBUTTON_DOWN    (1 << 0)
#define xgemouse_LBUTTON_CHANGE  (1 << 1)
#define xgemouse_RBUTTON_DOWN    (1 << 2)
#define xgemouse_RBUTTON_CHANGE  (1 << 3)
#define xgemouse_MBUTTON_DOWN    (1 << 4)
#define xgemouse_MBUTTON_CHANGE  (1 << 5)
#define xgemouse_WHEELFW_DOWN    (1 << 6)
#define xgemouse_WHEELFW_CHANGE  (1 << 7)
#define xgemouse_WHEELBK_DOWN    (1 << 8)
#define xgemouse_WHEELBK_CHANGE  (1 << 9)

#define xgemsg_NULL                              0
#define xgemsg_INIT                          0x100

#define xgemsg_KEY                           0x101
#define xgemsg_SPECIAL_KEY                   0x102
#define xgemsg_MMOVE                         0x103
#define xgemsg_MCLICK                        0x104
#define xgemsg_OTHEREVENT                    0x105

#define xgemsg_ENTERING                      0x106
#define xgemsg_EXITING                       0x107
#define xgemsg_RESIZE                        0x108
#define xgemsg_MOVE                          0x109
#define xgemsg_BUTTON_COMMAND                0x10A
#define xgemsg_SWITCH_COMMAND                0x10B
#define xgemsg_SLIDEBAR_COMMAND              0x10C
#define xgemsg_SLIDEBAR2_COMMAND             0x10D
#define xgemsg_DIAL_COMMAND                  0x10E
#define xgemsg_TEXT_EDIT_VERIFY              0x10F
#define xgemsg_TEXT_EDIT_ENTER               0x110
#define xgemsg_TEXT_EDIT_ESCAPE              0x111
#define xgemsg_INT_WIDGET_COMMAND            0x112
#define xgemsg_LISTBOX_ITEM_SET              0x113
#define xgemsg_LISTBOX_ITEM_PICK             0x114
#define xgemsg_QUATROTBALL_COMMAND           0x115

#define xgemsg_2DWIN_RESIZE                  0x116
#define xgemsg_2DWIN_PROJCHANGE              0x117
#define xgemsg_2DWIN_PICK_POINT              0x118
#define xgemsg_2DWIN_MOVE_POINT              0x119
#define xgemsg_2DWIN_SELECT_POINTS           0x11A
#define xgemsg_2DWIN_UNSELECT_POINTS         0x11B
#define xgemsg_2DWIN_SPECIAL_SELECT          0x11C
#define xgemsg_2DWIN_SPECIAL_UNSELECT        0x11D
#define xgemsg_2DWIN_CHANGE_TRANS            0x11E
#define xgemsg_2DWIN_SAVE_POINTS             0x11F
#define xgemsg_2DWIN_TRANSFORM_POINTS        0x120
#define xgemsg_2DWIN_TRANSFORM_SPECIAL       0x121
#define xgemsg_2DWIN_FIND_REFBBOX            0x122
#define xgemsg_2DWIN_UNDO                    0x123
#define xgemsg_2DWIN_KEY                     0x124
#define xgemsg_2DWIN_ERROR                   0x125

#define xgemsg_3DWIN_RESIZE                  0x126
#define xgemsg_3DWIN_PROJCHANGE              0x127
#define xgemsg_3DWIN_PICK_POINT              0x128
#define xgemsg_3DWIN_MOVE_POINT              0x129
#define xgemsg_3DWIN_SELECT_POINTS           0x12A
#define xgemsg_3DWIN_UNSELECT_POINTS         0x12B
#define xgemsg_3DWIN_SPECIAL_SELECT          0x12C
#define xgemsg_3DWIN_SPECIAL_UNSELECT        0x12D
#define xgemsg_3DWIN_CHANGE_TRANS            0x12E
#define xgemsg_3DWIN_SAVE_POINTS             0x12F
#define xgemsg_3DWIN_TRANSFORM_POINTS        0x130
#define xgemsg_3DWIN_TRANSFORM_SPECIAL       0x131
#define xgemsg_3DWIN_FIND_REFBBOX            0x132
#define xgemsg_3DWIN_UNDO                    0x133
#define xgemsg_3DWIN_KEY                     0x134
#define xgemsg_3DWIN_ERROR                   0x135

#define xgemsg_KNOTWIN_CHANGE_KNOT           0x136
#define xgemsg_KNOTWIN_INSERT_KNOT           0x137
#define xgemsg_KNOTWIN_REMOVE_KNOT           0x138
#define xgemsg_KNOTWIN_CHANGE_ALTKNOT        0x139
#define xgemsg_KNOTWIN_INSERT_ALTKNOT        0x13A
#define xgemsg_KNOTWIN_REMOVE_ALTKNOT        0x13B
#define xgemsg_KNOTWIN_MCLICK                0x13C
#define xgemsg_KNOTWIN_MMOVE                 0x13D
#define xgemsg_KNOTWIN_CHANGE_MAPPING        0x13E
#define xgemsg_KNOTWIN_ERROR                 0x13F

#define xgemsg_T2KNOTWIN_RESIZE              0x140
#define xgemsg_T2KNOTWIN_PROJCHANGE          0x141
#define xgemsg_T2KNOTWIN_CHANGE_KNOT_U       0x142
#define xgemsg_T2KNOTWIN_CHANGE_KNOT_V       0x143
#define xgemsg_T2KNOTWIN_INSERT_KNOT_U       0x144
#define xgemsg_T2KNOTWIN_INSERT_KNOT_V       0x145
#define xgemsg_T2KNOTWIN_REMOVE_KNOT_U       0x146
#define xgemsg_T2KNOTWIN_REMOVE_KNOT_V       0x147
#define xgemsg_T2KNOTWIN_CHANGE_ALTKNOT_U    0x148
#define xgemsg_T2KNOTWIN_CHANGE_ALTKNOT_V    0x149
#define xgemsg_T2KNOTWIN_INSERT_ALTKNOT_U    0x14A
#define xgemsg_T2KNOTWIN_INSERT_ALTKNOT_V    0x14B
#define xgemsg_T2KNOTWIN_REMOVE_ALTKNOT_U    0x14C
#define xgemsg_T2KNOTWIN_REMOVE_ALTKNOT_V    0x14D
#define xgemsg_T2KNOTWIN_SELECT_POINTS       0x14E
#define xgemsg_T2KNOTWIN_UNSELECT_POINTS     0x14F
#define xgemsg_T2KNOTWIN_CHANGE_MAPPING      0x150
#define xgemsg_T2KNOTWIN_ERROR               0x151

#define xgemsg_POPUP_REMOVED                 0x152
#define xgemsg_POPUPS_REMOVED                0x153

#define xgemsg_USER_MESSAGE_DISMISSED        0x154

#define xgemsg_IDLE_COMMAND                  0x155

#define xgemsg_CHILD_MESSAGE                 0x156
#define xgemsg_CHILD_FAILURE                 0x157

#define xgemsg_LAST_MESSAGE xgemsg_CHILD_FAILURE

#define xgestate_NOTHING                      0
#define xgestate_MOVINGSLIDE                  1
#define xgestate_MOVINGSLIDE2A                2
#define xgestate_MOVINGSLIDE2B                3
#define xgestate_TURNINGDIAL                  4
#define xgestate_QUATROT_TURNING1             5
#define xgestate_QUATROT_TURNING2             6
#define xgestate_QUATROT_TURNING3             7
#define xgestate_MESSAGE                      8
#define xgestate_RESIZING_X                   9
#define xgestate_RESIZING_Y                  10
#define xgestate_RESIZING_XY                 11
#define xgestate_TEXT_EDITING                12
#define xgestate_2DWIN_MOVINGPOINT           13
#define xgestate_2DWIN_PANNING               14
#define xgestate_2DWIN_ZOOMING               15
#define xgestate_2DWIN_SELECTING             16
#define xgestate_2DWIN_UNSELECTING           17
#define xgestate_2DWIN_MOVING_GEOM_WIDGET    18
#define xgestate_2DWIN_USING_GEOM_WIDGET     19
#define xgestate_2DWIN_ALTUSING_GEOM_WIDGET  20
#define xgestate_2DWIN_USING_SPECIAL_WIDGET  21
#define xgestate_3DWIN_MOVINGPOINT           22
#define xgestate_3DWIN_PARPANNING            23
#define xgestate_3DWIN_PARZOOMING            24
#define xgestate_3DWIN_TURNING_VIEWER        25
#define xgestate_3DWIN_PANNING               26
#define xgestate_3DWIN_ZOOMING               27
#define xgestate_3DWIN_SELECTING             28
#define xgestate_3DWIN_UNSELECTING           29
#define xgestate_3DWIN_MOVING_GEOM_WIDGET    30
#define xgestate_3DWIN_USING_GEOM_WIDGET     31
#define xgestate_3DWIN_ALTUSING_GEOM_WIDGET  32
#define xgestate_3DWIN_USING_SPECIAL_WIDGET  33
#define xgestate_KNOTWIN_MOVINGKNOT          34
#define xgestate_KNOTWIN_PANNING             35
#define xgestate_KNOTWIN_ZOOMING             36
#define xgestate_T2KNOTWIN_MOVINGKNOT_U      37
#define xgestate_T2KNOTWIN_MOVINGKNOT_V      38
#define xgestate_T2KNOTWIN_MOVING_POINT      39
#define xgestate_T2KNOTWIN_PANNING           40
#define xgestate_T2KNOTWIN_ZOOMING           41
#define xgestate_T2KNOTWIN_SELECTING         42
#define xgestate_T2KNOTWIN_UNSELECTING       43
#define xgestate_LISTBOX_PICKING             44
#define xgestate_LAST xgestate_LISTBOX_PICKING

#define xgeCURSOR_CROSSHAIR xgecursor[0]
#define xgeCURSOR_HAND      xgecursor[1]
#define xgeCURSOR_PENCIL    xgecursor[2]
#define xgeCURSOR_FLEUR     xgecursor[3]
#define xgeCURSOR_ARROW     xgecursor[4]
#define xgeCURSOR_WATCH     xgecursor[5]
#define xgeCURSOR_CIRCLE    xgecursor[6]
#define xgeCURSOR_DEFAULT   xgecursor[7]
#define xgeCURSOR_INVISIBLE xgecursor[8]
\end{listingC}

\section{Colours}

\begin{listingC}
#ifndef XGERGB_H
#include "xgergb.h"
#endif

#define xgec_MENU_BACKGROUND       xgec_Grey5
#define xgec_INFOMSG_BACKGROUND    xgec_Grey4
#define xgec_ERRORMSG_BACKGROUND   xgec_Red
#define xgec_WARNINGMSG_BACKGROUND xgec_DarkMagenta
\end{listingC}

\begin{listingC}
xgecolour_int xge_PixelColourf ( float r, float g, float b );
xgecolour_int xge_PixelColour ( byte r, byte g, byte b );
void xge_GetPixelColour ( xgecolour_int pixel,
                          byte *r, byte *g, byte *b );
void xge_GetPixelColourf ( xgecolour_int pixel,
                           float *r, float *g, float *b );
\end{listingC}


\section{Xlib procedure wrappers}

\begin{listingC}
#define xgeSetBackground(colour) \
  XSetBackground(xgedisplay,xgegc,colour)
#define xgeSetForeground(colour) \
  XSetForeground(xgedisplay,xgegc,colour)
#define xgeSetLineAttributes(width,line_style,\
    cap_style,join_style) \
  XSetLineAttributes(xgedisplay,xgegc,width,line_style,cap_style, \
    join_style)
#define xgeSetDashes(n,dash_list,offset) \
  XSetDashes(xgedisplay,xgegc,offset,dash_list,n)

#define xgeDrawRectangle(w,h,x,y) \
  XDrawRectangle(xgedisplay,xgepixmap,xgegc,x,y,w,h)
#define xgeFillRectangle(w,h,x,y) \
  XFillRectangle(xgedisplay,xgepixmap,xgegc,x,y,w,h)
#define xgeDrawString(string,x,y) \
  XDrawString(xgedisplay,xgepixmap,xgegc,x,y,string,strlen(string))
#define xgeDrawLine(x0,y0,x1,y1) \
  XDrawLine(xgedisplay,xgepixmap,xgegc,x0,y0,x1,y1)
#define xgeDrawLines(n,p) \
  XDrawLines(xgedisplay,xgepixmap,xgegc,p,n,CoordModeOrigin)
#define xgeDrawArc(w,h,x,y,a0,a1) \
  XDrawArc(xgedisplay,xgepixmap,xgegc,x,y,w,h,a0,a1)
#define xgeFillArc(w,h,x,y,a0,a1) \
  XFillArc(xgedisplay,xgepixmap,xgegc,x,y,w,h,a0,a1)
#define xgeDrawPoint(x,y) \
  XDrawPoint(xgedisplay,xgepixmap,xgegc,x,y)
#define xgeDrawPoints(n,p) \
  XDrawPoints(xgedisplay,xgepixmap,xgegc,p,n,CoordModeOrigin)
#define xgeFillPolygon(shape,n,p) \
  XFillPolygon(xgedisplay,xgepixmap,xgegc,p,n,shape,CoordModeOrigin)

#define xgeCopyRectOnScreen(w,h,x,y) \
  XCopyArea(xgedisplay,xgepixmap,xgewindow,xgegc,x,y,w,h,x,y)
#define xgeRaiseWindow() \
  XRaiseWindow(xgedisplay,xgewindow)
#define xgeResizeWindow(w,h) \
  XResizeWindow(xgedisplay,xgewindow,w,h)
#define xgeMoveWindow(x,y) \
  XMoveWindow(xgedisplay,xgewindow,x,y)
\end{listingC}

\section{Global variables}

\begin{listingC}
extern int   xge_winnum;
extern unsigned int xge_mouse_buttons;
extern int   xge_mouse_x, xge_mouse_y;
extern short xge_xx, xge_yy;

extern Display     *xgedisplay;
extern XVisualInfo *xgevisualinfo;
extern Colormap    xgecolormap;
extern int         xgescreen;
extern Window      xgeroot;
extern Window      xgewindow;
extern Pixmap      xgepixmap;
extern GC          xgegc;
extern Visual      *xgevisual;
extern XSizeHints  xgehints;
extern Cursor      xgecursor[];
extern KeySym      xgekeysym;
extern XEvent      xgeevent;

typedef struct {
         unsigned short r_bits,  g_bits,  b_bits;
         char           nr_bits, ng_bits, nb_bits;
         unsigned char  r_shift, g_shift, b_shift;
         unsigned char  r_mask, g_mask, b_mask;
         float          ar, ag, ab;
       } xge_rgbmap_bits;
extern xge_rgbmap_bits xge_rgbmap;

extern float      xge_aspect;

extern unsigned int xge_current_width, xge_current_height;

extern char       *xge_p_name;
extern char       xge_done;
extern short      xge_prevx, xge_prevy;

extern xgecolour_int xge_foreground, xge_background;
extern int           xge_nplanes;
extern xgecolour_int *xge_palette;
extern const char    *xge_colour_name[];
extern xge_widget    *xge_null_widget;
\end{listingC}

\section{Widgets}

\begin{listingC}
typedef struct xge_widget {
          int   id;
          short w, h, x, y;
          void *data0, *data1, *data2;
          short xofs, yofs;
          char  rpos;
          char  window_num;
          short state;
          boolean (*msgproc)(struct xge_widget*,int,int,short,short);
          void (*redraw) ( struct xge_widget*, boolean );
          struct xge_widget *next, *prev, *up;
        } xge_widget;

typedef boolean (*xge_message_proc) ( struct xge_widget *er,
                                  int msg, int key, short x, short y );
typedef void (*xge_redraw_proc) ( struct xge_widget *er,
                                  boolean onscreen );
\end{listingC}


\subsection{Generic widget constructor}

\begin{listingC}
xge_widget *xge_NewWidget (
         char window_num, xge_widget *prev, int id,
         short w, short h, short x, short y,
         void *data0, void *data1,
         boolean (*msgproc)(xge_widget*, int, int, short, short),
         void (*redraw)(xge_widget*, boolean) );
void xge_SetWidgetPositioning ( xge_widget *edr,
                                char rpos, short xofs, short yofs );
\end{listingC}


\subsection{Empty widget}

\begin{listingC}
void xge_DrawEmpty ( xge_widget *er, boolean onscreen );
boolean xge_EmptyMsg ( xge_widget *er,
                       int msg, int key, short x, short y );
xge_widget *xge_NewEmptyWidget ( char window_num,
                                 xge_widget *prev, int id,
                                 short w, short h, short x, short y );
\end{listingC}

\subsection{Menu widgets}

\begin{listingC}
void xge_DrawMenu ( xge_widget *er, boolean onscreen );
boolean xge_MenuMsg ( xge_widget *er,
                      int msg, int key, short x, short y );
boolean xge_PopupMenuMsg ( xge_widget *er,
                           int msg, int key, short x, short y );
xge_widget *xge_NewMenu ( char window_num, xge_widget *prev,
                          int id,
                          short w, short h, short x, short y,
                          xge_widget *widgetlist );
void xge_DrawFMenu ( xge_widget *er, boolean onscreen );
xge_widget *xge_NewFMenu ( char window_num, xge_widget *prev,
                           int id,
                           short w, short h, short x, short y,
                           xge_widget *widgetlist );
void xge_SetMenuWidgets ( xge_widget *menu, xge_widget *widgetlist,
                          boolean redraw );
\end{listingC}


\subsection{Switch widget}

\begin{listingC}
void xge_DrawSwitch ( xge_widget *er, boolean onscreen );
boolean xge_SwitchMsg ( xge_widget *er,
                        int msg, int key, short x, short y );
xge_widget *xge_NewSwitch ( char window_num, xge_widget *prev,
                            int id,
                            short w, short h, short x, short y,
                            char *title, boolean *sw );
\end{listingC}


\subsection{Button widget}

\begin{listingC}
void xge_DrawButton ( xge_widget *er, boolean onscreen );
boolean xge_ButtonMsg ( xge_widget *er,
                        int msg, int key, short x, short y );
xge_widget *xge_NewButton ( char window_num, xge_widget *prev,
                            int id,
                            short w, short h, short x, short y,
                            char *title );
\end{listingC}


\subsection{Slidebar widgets}

\begin{listingC}
void xge_DrawSlidebarf ( xge_widget *er, boolean onscreen );
boolean xge_SlidebarfMsg ( xge_widget *er,
                           int msg, int key, short x, short y );
xge_widget *xge_NewSlidebarf ( char window_num, xge_widget *prev,
                               int id,
                               short w, short h, short x, short y,
                               float *data );

void xge_DrawSlidebarfRGB ( xge_widget *er, boolean onscreen );
xge_widget *xge_NewSlidebarfRGB ( char window_num, xge_widget *prev,
                                  int id,
                                  short w, short h, short x, short y,
                                  float *data );

void xge_DrawVSlidebarf ( xge_widget *er, boolean onscreen );
boolean xge_VSlidebarfMsg ( xge_widget *er,
                            int msg, int key, short x, short y );
xge_widget *xge_NewVSlidebarf ( char window_num, xge_widget *prev,
                                int id,
                                short w, short h, short x, short y,
                                float *data );

void xge_DrawSlidebar2f ( xge_widget *er, boolean onscreen );
boolean xge_Slidebar2fMsg ( xge_widget *er,
                            int msg, int key, short x, short y );
xge_widget *xge_NewSlidebar2f ( char window_num, xge_widget *prev,
                                int id,
                                short w, short h, short x, short y,
                                float *data );

void xge_DrawVSlidebar2f ( xge_widget *er, boolean onscreen );
boolean xge_VSlidebar2fMsg ( xge_widget *er,
                             int msg, int key, short x, short y );
xge_widget *xge_NewVSlidebar2f ( char window_num, xge_widget *prev,
                                 int id,
                                 short w, short h, short x, short y,
                                 float *data );

float xge_LinSlidebarValuef ( float xmin, float xmax, float t );
float xge_LogSlidebarValuef ( float xmin, float xmax, float t );
\end{listingC}


\subsection{Dial widget}

\begin{listingC}
void xge_DrawDialf ( xge_widget *er, boolean onscreen );
boolean xge_DialfMsg ( xge_widget *er,
                       int msg, int key, short x, short y );
xge_widget *xge_NewDialf ( char window_num, xge_widget *prev,
                           int id,
                           short w, short h, short x, short y,
                           char *title, float *data );
\end{listingC}


\newpage
\subsection{Quaternion ball widget}

\begin{listingC}
typedef struct xge_quatrotballf {
    xge_widget  *er;
    quaternionf *q;
    trans3f     *tr;
    vector3f    axis;
    short       xc, yc, r1, r2, R;
    boolean     axis_ok, insert;
  } xge_quatrotballf;

void xge_DrawQuatRotBallf ( xge_widget *er, boolean onscreen );
boolean xge_QuatRotBallfMsg ( xge_widget *er,
                              int msg, int key, short x, short y );
xge_widget *xge_NewQuatRotBallf ( char window_num, xge_widget *prev,
                         int id,
                         short w, short h, short x, short y, short R,
                         xge_quatrotballf *qball, quaternionf *q,
                         trans3f *tr, char *title );
\end{listingC}


\subsection{Text output widget}

\begin{listingC}
void xge_DrawText ( xge_widget *er, boolean onscreen );
xge_widget *xge_NewTextWidget ( char window_num, xge_widget *prev,
                                int id,
                                short w, short h, short x, short y,
                                char *text );
\end{listingC}


\subsection{Colour sample widget}

\begin{listingC}
void xge_DrawRGBSamplef ( xge_widget *er, boolean onscreen );
xge_widget *xge_NewRGBSamplef ( char window_num, xge_widget *prev,
                                int id,
                                short w, short h, short x, short y,
                                float *data );
\end{listingC}


\newpage
\subsection{Text editing widget}

\begin{listingC}
typedef struct xge_string_ed {
    xge_widget *er;
    short maxlength,  /* maximal string length */
          chdisp,     /* number of characters displayed */
          start,      /* first character displayed */
          pos;        /* text cursor position */
  } xge_string_ed;

void xge_DrawStringEd ( xge_widget *er, boolean onscreen );
boolean xge_StringEdMsg ( xge_widget *er,
                          int msg, int key, short x, short y );
xge_widget *xge_NewStringEd ( char window_num, xge_widget *prev,
                    int id,
                    short w, short h, short x, short y,
                    short maxlength, char *text, xge_string_ed *ed );
\end{listingC}


\subsection{Integer widget}

\begin{listingC}
typedef struct xge_int_widget {
    xge_widget *er;
    int        minvalue, maxvalue;
    char       *title;
  } xge_int_widget;

void xge_DrawIntWidget ( xge_widget *er, boolean onscreen );
boolean xge_IntWidgetMsg ( xge_widget *er,
                           int msg, int key, short x, short y );
xge_widget *xge_NewIntWidget ( char window_num, xge_widget *prev,
                    int id,
                    short w, short h, short x, short y,
                    int minvalue, int maxvalue,
                    xge_int_widget *iw, char *title, int *valptr );
\end{listingC}


\newpage
\subsection{List widgets}

\begin{listingC}
#define xge_LISTDIST 16

typedef struct xge_listbox {
    xge_widget   *er;
    char          dlistnpos;   /* number of positions displayed */
    char          maxitl;      /* maximal item length, in characters */
    short         nitems;      /* current number of list elements */
    short         fditem;      /* first displayed item */
    short         currentitem; /* current item */
    int           *itemind;    /* indexes to the item strings */
    char          *itemstr;    /* item strings */
    xgecolour_int bk0, bk1;    /* background colours for the items */
  } xge_listbox;

void xge_DrawListBox ( xge_widget *er, boolean onscreen );
boolean xge_ListBoxMsg ( xge_widget *er,
                         int msg, int key, short x, short y );
xge_widget *xge_NewListBox ( char window_num, xge_widget *prev,
                             int id,
                             short w, short h, short x, short y,
                             xge_listbox *listbox );
void xge_ClearListBox ( xge_listbox *lbox );
void xge_ShortenString ( const char *s, char *buf, int maxlen );
boolean xge_GetCurrentListBoxString ( xge_listbox *lbox,
                                      char *string );
int xge_MoveInListBox ( xge_listbox *lbox, short amount );
\end{listingC}

\begin{listingC}
boolean xge_SetupFileList ( xge_listbox *lbox, const char *dir,
                            const char *filter );
boolean xge_SetupDirList ( xge_listbox *lbox, const char *dir,
                           const char *filter, const char *prevdir );
boolean xge_FilterMatches ( const char *name, const char *filter );
\end{listingC}


\newpage
\subsection{2D~geometry editing widget}

\begin{listingC}
#define xge_2DWIN_MIN_ZOOM             0.01
#define xge_2DWIN_MAX_ZOOM           100.0

#define xge_2DWIN_NO_TOOL                0
#define xge_2DWIN_MOVING_TOOL            1
#define xge_2DWIN_SCALING_TOOL           2
#define xge_2DWIN_ROTATING_TOOL          3
#define xge_2DWIN_SHEAR_TOOL             4
#define xge_2DWIN_SELECTING_TOOL         5
#define xge_2DWIN_PANNING_TOOL           6
#define xge_2DWIN_SPECIAL_SELECTING_TOOL 7
#define xge_2DWIN_SPECIAL_TRANS_TOOL     8
\end{listingC}

\begin{listingC}
typedef struct xge_2Dwinf {
    xge_widget  *er;
    CameraRecf  CPos;
    Box2f       DefBBox, RefBBox;
    boolean     panning, selecting_mode, special_selecting_mode;
    boolean     display_coord, inside;
    boolean     moving_tool, scaling_tool, rotating_tool, shear_tool,
                special_trans_tool;
    char        current_tool;
    char        tool_mode;
    int         current_tab, current_point;
    short       xx, yy;
    float       zoom;
    Box2s       selection_rect;
    point2f     saved_centre;
    point2f     scaling_centre;
    vector2f    scaling_factors;
    short       scaling_size;
    point2f     rotating_centre;
    short       rotating_radius;
    vector2f    trans_params;
    point2f     shear_centre;
    vector2f    shear_axis[2];
    float       shear_radius;
    trans2f     gwtrans;
  } xge_2Dwinf;
\end{listingC}

\begin{listingC}
boolean xge_2DwinfMsg ( xge_widget *er,
                        int msg, int key, short x, short y );
xge_widget *xge_New2Dwinf ( char window_num, xge_widget *prev,
                            int id,
                            short w, short h, short x, short y,
                            xge_2Dwinf *_2Dwin,
                            void (*redraw)(xge_widget*, boolean) );
\end{listingC}

\begin{listingC}
void xge_2DwinfSetDefBBox ( xge_2Dwinf *_2Dwin,
                            float x0, float x1, float y0, float y1 );
void xge_2DwinfSetupProjection ( xge_2Dwinf *_2Dwin );
void xge_2DwinfPan ( xge_widget *er, short x, short y );
void xge_2DwinfZoom ( xge_widget *er, short y );
void xge_2DwinfInitProjection ( xge_2Dwinf *_2Dwin,
                            float x0, float x1, float y0, float y1 );
void xge_2DwinfResetGeomWidgets ( xge_2Dwinf *_2Dwin );
void xge_2DwinfResetGeomWidgetPos ( xge_2Dwinf *_2Dwin );
void xge_2DwinfEnableGeomWidget ( xge_2Dwinf *_2Dwin, char tool );
void xge_2DwinfDrawGeomWidgets ( xge_widget *er );
char xge_2DwinfIsItAGeomWidget ( xge_2Dwinf *_2Dwin,
                                 int key, short x, short y );
void xge_2DwinfMoveGeomWidget ( xge_2Dwinf *_2Dwin,
                                short x, short y );
boolean xge_2DwinfApplyGeomWidget ( xge_2Dwinf *_2Dwin,
                                    short x, short y, boolean alt );
void xge_2DwinfExitWidgetMode ( xge_2Dwinf *_2Dwin );
void xge_2DwinfResetGeomWidget ( xge_2Dwinf *_2Dwin );
void xge_2DwinfDrawCursorPos ( xge_2Dwinf *_2Dwin,
                               short x, short y );
\end{listingC}


\subsection{Four window widget}

\begin{listingC}
typedef struct xge_fourww {
    xge_widget *er;
    xge_widget *win[4];
    float      xsfr, ysfr;
    short      splitx, splity;
    boolean    resized;
    char       zoomwin;
  } xge_fourww;
\end{listingC}

\begin{listingC}
boolean xge_CompSizeFourWW ( xge_widget *er, char cs );
void xge_DrawFourWW ( xge_widget *er, boolean onscreen );
boolean xge_FourWWMsg ( xge_widget *er,
                        int msg, int key, short x, short y );
xge_widget *xge_NewFourWW ( char window_num, xge_widget *prev,
                            int id,
                            short w, short h, short x, short y,
                            xge_widget *ww, xge_fourww *fwwdata );
\end{listingC}


\subsection{3D geometry editing widget}

\begin{listingC}
#define xge_3DWIN_MIN_PARZOOM   0.01
#define xge_3DWIN_MAX_PARZOOM 100.0
#define xge_3DWIN_MIN_ZOOM      0.1
#define xge_3DWIN_MAX_ZOOM   1000.0

#define xge_3DWIN_NO_TOOL                xge_2DWIN_NO_TOOL
#define xge_3DWIN_MOVING_TOOL            xge_2DWIN_MOVING_TOOL
#define xge_3DWIN_SCALING_TOOL           xge_2DWIN_SCALING_TOOL
#define xge_3DWIN_ROTATING_TOOL          xge_2DWIN_ROTATING_TOOL
#define xge_3DWIN_SHEAR_TOOL             xge_2DWIN_SHEAR_TOOL
#define xge_3DWIN_SELECTING_TOOL         xge_2DWIN_SELECTING_TOOL
#define xge_3DWIN_PANNING_TOOL           xge_2DWIN_PANNING_TOOL
#define xge_3DWIN_SPECIAL_SELECTING_TOOL \
                                  xge_2DWIN_SPECIAL_SELECTING_TOOL
#define xge_3DWIN_SPECIAL_TRANS_TOOL     xge_2DWIN_SPECIAL_TRANS_TOOL
\end{listingC}

\begin{listingC}
typedef struct xge_3Dwinf {
    xge_fourww  fww;         /* this must be the first component */
    xge_widget  *cwin[4];
    CameraRecf  CPos[5];
    Box3f       DefBBox, RefBBox, WinBBox, PerspBBox;
    boolean     panning, selecting_mode, special_selecting_mode;
    boolean     display_coord;
    signed char CoordWin;
    boolean     moving_tool, scaling_tool, rotating_tool, shear_tool,
                special_trans_tool;
    char        current_tool;
    char        tool_mode;
    int         current_tab, current_point;
    short       xx, yy;
    float       perspzoom;
    Box2s       selection_rect;
    point3f     saved_centre;
    point3f     scaling_centre;
    vector3f    scaling_factors;
    short       scaling_size;
    point3f     rotating_centre;
    short       rotating_radius;
    vector3f    trans_params;
    point3f     shear_centre;
    vector3f    shear_axis[3];
    float       shear_radius;
    trans3f     gwtrans;
  } xge_3Dwinf;
\end{listingC}

\begin{listingC}
xge_widget *xge_New3Dwinf ( char window_num, xge_widget *prev,
                        int id,
                        short w, short h, short x, short y,
                        xge_3Dwinf *_3Dwin,
                        void (*pararedraw)(xge_widget*, boolean),
                        void (*perspredraw)(xge_widget*, boolean) );

void xge_3DwinfSetDefBBox ( xge_3Dwinf *_3Dwin, float x0, float x1,
                            float y0, float y1, float z0, float z1 );
void xge_3DwinfSetupParProj ( xge_3Dwinf *_3Dwin, Box3f *bbox );
void xge_3DwinfSetupPerspProj ( xge_3Dwinf *_3Dwin,
                                boolean resetpos );
void xge_3DwinfUpdatePerspProj ( xge_3Dwinf *_3Dwin );
void xge_3DwinfPanParWindows ( xge_widget *er, short x, short y );
void xge_3DwinfZoomParWindows ( xge_widget *er, short y );
void xge_3DwinfPanPerspWindow ( xge_widget *er, short x, short y );
void xge_3DwinfInitProjections ( xge_3Dwinf *_3Dwin,
       float x0, float x1, float y0, float y1, float z0, float z1 );
void xge_3DwinfResetGeomWidgets ( xge_3Dwinf *_3Dwin );
void xge_3DwinfResetGeomWidgetPos ( xge_3Dwinf *_3Dwin );
void xge_3DwinfEnableGeomWidget ( xge_3Dwinf *_3Dwin, char tool );
void xge_3DwinfDrawCursorPos ( xge_3Dwinf *_3Dwin,
                               int id, short x, short y );
void xge_3DwinfDrawSelectionRect ( xge_widget *er );
void xge_3DwinfDrawGeomWidgets ( xge_widget *er );
char xge_3DwinfIsItAGeomWidget ( xge_3Dwinf *_3Dwin, int id,
                                 int key, short x, short y );
void xge_3DwinfMoveGeomWidget ( xge_3Dwinf *_3Dwin,
                                int id, short x, short y );
boolean xge_3DwinfApplyGeomWidget ( xge_3Dwinf *_3Dwin,
                        int id, short x, short y, boolean alt );
void xge_3DwinfExitWidgetMode ( xge_3Dwinf *_3Dwin );
void xge_3DwinfResetGeomWidget ( xge_3Dwinf *_3Dwin );
void xge_3DwinfSavePerspCamera ( xge_3Dwinf *_3Dwin );
void xge_3DwinfSwapPerspCameras ( xge_3Dwinf *_3Dwin );
\end{listingC}


\subsection{Knot sequence editing widget}

\begin{listingC}
#define xge_KNOTWIN_MIN_SCALE   0.01
#define xge_KNOTWIN_MAX_SCALE  100.0
#define xge_KNOT_EPS          1.0e-4
\end{listingC}

\begin{listingC}
typedef struct {
    xge_widget    *er;
    boolean       panning, display_coord, moving_many, locked;
    boolean       closed, altkn, switchkn;
    float         akm, bkm, umin, umax, knotscf, knotshf;
    int           clcK;
    float         clcT;
    unsigned char current_mult;
    short         xx;
    int           maxknots, lastknot, degree;
    float         *knots;
    int           maxaltknots, lastaltknot, altdegree;
    float         *altknots;
    float         newknot;
    int           current_knot;
  } xge_KnotWinf;
\end{listingC}

\begin{listingC}
void xge_DrawKnotWinf ( xge_widget *er, boolean onscreen );
boolean xge_KnotWinfMsg ( xge_widget *er,
                          int msg, int key, short x, short y );
xge_widget *xge_NewKnotWinf ( char window_num, xge_widget *prev,
                      int id,
                      short w, short h, short x, short y,
                      xge_KnotWinf *knw, int maxknots, float *knots );

void xge_KnotWinfDrawCursorPos ( xge_KnotWinf *knw );
void xge_KnotWinfDrawAxis ( xge_KnotWinf *knw );
void xge_KnotWinfDrawKnots ( xge_KnotWinf *knw );
void xge_KnotWinfInitMapping ( xge_KnotWinf *knw,
                               float umin, float umax );
void xge_KnotWinfZoom ( xge_KnotWinf *knw, float scf );
void xge_KnotWinfPan ( xge_KnotWinf *knw, int dxi );
void xge_KnotWinfFindMapping ( xge_KnotWinf *knw );
void xge_KnotWinfResetMapping ( xge_KnotWinf *knw );
short xge_KnotWinfMapKnot ( xge_KnotWinf *knw, float u );
float xge_KnotWinfUnmapKnot ( xge_KnotWinf *knw, short xi );
boolean xge_KnotWinfFindNearestKnot ( xge_KnotWinf *knw,
                                      int x, int y );
boolean xge_KnotWinfSetKnot ( xge_KnotWinf *knw, short x );
boolean xge_KnotWinfInsertKnot ( xge_KnotWinf *knw, short x );
boolean xge_KnotWinfRemoveKnot ( xge_KnotWinf *knw );
void xge_KnotWinfSetAltKnots ( xge_KnotWinf *knw,
         int altmaxkn, int lastaltkn, int altdeg, float *altknots );
void xge_KnotWinfSwitchAltKnots ( xge_KnotWinf *knw );
\end{listingC}


\subsection{Two knot sequences editing widget}

\begin{listingC}
typedef struct {
    xge_widget  *er;
    CameraRecf  CPos;
    Box2f       DefBBox, RefBBox;
    point3f     centre;
    boolean     panning, selecting_mode, moving_many,
                locked_u, locked_v;
    boolean     display_coord, inside;
    unsigned char current_mult;
    int         current_item;
    short       knot_margin;
    short       xx, yy;
    float       zoom;
    Box2s       selection_rect;
    boolean     closed_u, closed_v;
    int         clcKu, clcKv;
    float       clcTu, clcTv;
    int         maxknots_u, lastknot_u, degree_u;
    float       *knots_u;
    int         maxknots_v, lastknot_v, degree_v;
    float       *knots_v;
    float       newknot;
    boolean     altknu, switchknu, altknv, switchknv;
    int         altmaxknots_u, altlastknot_u, altdeg_u;
    float       *altknots_u;
    int         altmaxknots_v, altlastknot_v, altdeg_v;
    float       *altknots_v;
  } xge_T2KnotWinf;
\end{listingC}

\begin{listingC}
boolean xge_T2KnotWinfMsg ( xge_widget *er,
                            int msg, int key, short x, short y );
xge_widget *xge_NewT2KnotWinf ( char window_num, xge_widget *prev,
                                int id,
                                short w, short h, short x, short y,
                                short knot_margin,
                                xge_T2KnotWinf *T2win,
                                void (*redraw)(xge_widget*, boolean),
                                int maxknots_u, float *knots_u,
                                int maxknots_v, float *knots_v );

void xge_T2KnotWinfDrawKnots ( xge_T2KnotWinf *T2win );
void xge_T2KnotWinfSetupMapping ( xge_T2KnotWinf *T2win );
void xge_T2KnotWinfInitMapping ( xge_T2KnotWinf *T2win,
                     float umin, float umax, float vmin, float vmax );
void xge_T2KnotWinfZoom ( xge_T2KnotWinf *T2win, short y );
boolean xge_T2KnotWinfPan ( xge_T2KnotWinf *T2win,
                            short x, short y );
void xge_T2KnotWinfFindMapping ( xge_T2KnotWinf *T2win );
void xge_T2KnotWinfResetMapping ( xge_T2KnotWinf *T2win );

char xge_T2KnotWinfFindDomWinRegion ( xge_T2KnotWinf *T2win,
                                      int x, int y );
char xge_T2KnotWinfFindNearestKnot ( xge_T2KnotWinf *T2win,
                                     int x, int y );
short xge_T2KnotWinfMapKnotU ( xge_T2KnotWinf *T2win, float u );
float xge_T2KnotWinfUnmapKnotU ( xge_T2KnotWinf *T2win, short xi );
short xge_T2KnotWinfMapKnotV ( xge_T2KnotWinf *T2win, float v );
float xge_T2KnotWinfUnmapKnotV ( xge_T2KnotWinf *T2win, short eta );
boolean xge_T2KnotWinfSetKnotU ( xge_T2KnotWinf *T2win, short x );
boolean xge_T2KnotWinfInsertKnotU ( xge_T2KnotWinf *T2win,
                                    short x );
boolean xge_T2KnotWinfRemoveKnotU ( xge_T2KnotWinf *T2win );
boolean xge_T2KnotWinfSetKnotV ( xge_T2KnotWinf *T2win, short y );
boolean xge_T2KnotWinfInsertKnotV ( xge_T2KnotWinf *T2win,
                                    short y );
boolean xge_T2KnotWinfRemoveKnotV ( xge_T2KnotWinf *T2win );
void xge_T2KnotWinfSelect ( xge_T2KnotWinf *T2win,
                            short x0, short x1, short y0, short y1 );
void xge_T2KnotWinfUnselect ( xge_T2KnotWinf *T2win,
                              short x0, short x1, short y0, short y1 );

void xge_T2KnotWinfSetAltKnots ( xge_T2KnotWinf *T2win,
               int altmaxknu, int lastaltknu, int altdegu,
               float *altknotsu,
               int altmaxknv, int lastaltknv, int altdegv,
               float *altknotsv );
void xge_T2KnotWinfSwitchAltKnots ( xge_T2KnotWinf *T2win,
               boolean altu, boolean altv );
void xge_T2KnotWinfDrawCursorPos ( xge_T2KnotWinf *T2win,
                                   short x, short y );
\end{listingC}


\subsection{Scrolling widget}

\begin{listingC}
typedef struct {
    xge_widget *er;
    xge_widget *contents, *clipw, *xsl, *ysl;
    float      x, y;
    boolean    xslon, yslon;
  } xge_scroll_widget;

void xge_SetupScrollWidgetPos ( xge_widget *er );
void xge_DrawScrollWidget ( xge_widget *er, boolean onscreen );
boolean xge_ScrollWidgetMsg ( xge_widget *er,
                              int msg, int key, short x, short y );
xge_widget *xge_NewScrollWidget ( char window_num, xge_widget *prev,
                      int id,
                      short w, short h, short x, short y,
                      xge_scroll_widget *sw, xge_widget *contents );
\end{listingC}


\newpage
\section{Input focus processing}

\begin{listingC}
void xge_GrabFocus ( xge_widget *er, boolean all );
void xge_ReleaseFocus ( xge_widget *er );
xge_widget *xge_GetFocusWidget ( char win );
\end{listingC}


\section{Popup widgets}

\begin{listingC}
void xge_AddPopup ( xge_widget *er );
void xge_RemovePopup ( boolean redraw );
void xge_RemovePopups ( boolean redraw );
boolean xge_IsPopupOn ( xge_widget *er );

void _xge_DisplayErrorMessage ( char *message,
                                xgecolour_int bk, int key );
void xge_DisplayErrorMessage ( char *message, int key );
void xge_DisplayWarningMessage ( char *message, int key );
void xge_DisplayInfoMessage ( char **msglines, int key );
\end{listingC}


\section[Application initialisation, message loop and closing]%
{Application initialisation, message loop \\ and closing}

\begin{listingC}
void xge_Init ( int argc, char *argv[],
                int (*callback)(xge_widget*,int,int,short,short),
                char *title );
void xge_MessageLoop ( void );
void xge_Cleanup ( void );
\end{listingC}


\section{Other procedures}

\begin{listingC}
void xge_OutPixels ( const xpoint *buf, int n );
void xge_DrawBC2f ( int n, const point2f *cp );
void xge_DrawBC2Rf ( int n, const point3f *cp );
void xge_DrawBC2d ( int n, const point2d *cp );
void xge_DrawBC2Rd ( int n, const point3d *cp );

int     xge_NewWindow ( char *title );
boolean xge_SetWindow ( int win );
int     xge_CurrentWindow ( void );
void    xge_SetWinEdRect ( xge_widget *edr );

int  xge_NewCursor ( int shape );
void xge_SetWindowCursor ( int win, Cursor cursor );
void xge_SetCurrentWindowCursor ( Cursor cursor );
void xge_SetOtherWindowsCursor ( Cursor cursor );

void xge_RedrawPopups ( void );
void xge_Redraw ( void );
void xge_RedrawAll ( void );

boolean xge_PointInRect ( xge_widget *edr, short x, short y );
void xge_BoundPoint ( xge_widget *er, short *x, short *y );
boolean xge_RectanglesIntersect (
              short wa, short ha, short xa, short ya,
              short wb, short hb, short xb, short yb );

boolean xge_IntersectXRectangles ( XRectangle *r1, XRectangle *r2 );
boolean xge_SetClipping ( xge_widget *edr );
void xge_ResetClipping ( void );

void xge_RepositionWidgets ( short w, short h, short x, short y,
                             xge_widget *edr );

void xge_DrawVShadedRect ( short w, short h, short x, short y,
                   xgecolour_int c0, xgecolour_int c1, short nb );
void xge_DrawHShadedRect ( short w, short h, short x, short y,
                   xgecolour_int c0, xgecolour_int c1, short nb );

void xge_OrderSelectionRect ( Box2s *sel_rect );
void xge_DrawGeomWinBackground ( xge_widget *er );
void xge_DrawGeomWinFrame ( xge_widget *er, boolean onscreen );
void xge_DrawGeomWinSelectionRect ( xge_widget *er,
                                    Box2s *sel_rect );

void xge_GetWindowSize ( void );
void xge_PostIdleCommand ( unsigned int key, short x, short y );

void xge_dispatch_message ( unsigned int msg, unsigned int key,
                            short x, short y );
void xge_get_message ( unsigned int *msg, unsigned int *key,
                       short *x, short *y );
\end{listingC}


\section{OpenGL support}

\begin{listingC}
#define xgleCopyGLRect(w,h,x,y) \
  XCopyArea(xgedisplay,xglepixmap,xgepixmap,xgegc,0,\
    xge_MAX_HEIGHT-h,w,h,x,y)
#define xgleClearColor3fv(rgb) \
  glClearColor(rgb[0],rgb[1],rgb[2],1.0)
\end{listingC}

\begin{listingC}
extern Pixmap      xglepixmap;
extern XID         _xglepixmap;
extern void        *xglecontext;

extern GLfloat xgle_palette[XGLE_PALETTE_LENGTH][3];
\end{listingC}

\begin{listingC}
void xgle_Init ( int argc, char *argv[],
                 int (*callback)(xge_widget*,int,int,short,short),
                 char *title,
                 boolean depth, boolean accum, boolean stencil );
void xgle_Cleanup ( void );
\end{listingC}

\begin{listingC}
void xgle_SetIdentMapping ( xge_widget *er );
\end{listingC}

\begin{listingC}
boolean xgle_SetGLCameraf ( CameraRecf *CPos );
boolean xgle_SetGLCamerad ( CameraRecd *CPos );
boolean xgle_SetGLaccCameraf ( CameraRecf *CPos,
                       float pixdx, float pixdy,
                       float eyedx, float eyedy, float focus );
boolean xgle_SetGLaccCamerad ( CameraRecd *CPos,
                       double pixdx, double pixdy,
                       double eyedx, double eyedy, double focus );
\end{listingC}

\begin{listingC}
void xgle_MultMatrix3f ( trans3f *tr );

void xgleDrawPoint ( int x, int y );
void xgleDrawPoints ( int n, XPoint *p );
void xgleDrawLine ( int x0, int y0, int x1, int y1 );
void xgleDrawRectangle ( int w, int h, int x, int y );
void xgleDrawString ( char *string, int x, int y );
\end{listingC}

\begin{listingC}
void xgle_DrawGeomWinBackground ( xge_widget *er, GLbitfield mask );

void xgle_2DwinfDrawCursorPos ( xge_2Dwinf *_2Dwin,
                                short x, short y );

void xgle_3DwinfDrawCursorPos ( xge_3Dwinf *_3Dwin,
                                int id, short x, short y );

void xgle_T2KnotWinfDrawCursorPos ( xge_T2KnotWinf *T2win,
                                    short x, short y );
\end{listingC}


\section{Interprocess communication}

\subsection{Overview}

\subsection{Common variables}

\begin{listingC}
extern pid_t xge_parent_pid, xge_child_pid;
extern int xge_pipe_in[2], xge_pipe_out[2];
extern Window xgeparentwindow, xgechildwindow;
\end{listingC}


\subsection{Parent side procedures}

\begin{listingC}
boolean xge_MakeTheChild ( const char *name,
                           const char *suffix, int magic );
boolean xge_ChildIsActive ( void );
void xge_CallTheChild ( int cmd, int size );
void xge_SignalTheChild ( void );
void xge_ParentFlushPipe ( void );
\end{listingC}


\subsection{Child side procedures}

\begin{listingC}
extern void (*xge_childcallback) ( int msg, int size );

void xge_CallTheParent ( int cmd, int size );
void xge_ChildCallYourself ( int cmd );
void xge_ChildMessageLoop ( void );
void xge_ChildFlushPipe ( void );
boolean xge_ChildInit ( int argc, char **argv, int magic,
                        void (*callback) ( int msg, int size ) );
\end{listingC}


